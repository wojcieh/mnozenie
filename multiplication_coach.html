<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mno偶enie dla Maych Mistrz贸w (5-8 lat)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for simple icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- PWA Manifest (za贸偶my, 偶e plik manifest.json jest dostpny) -->
    <link rel="manifest" href="manifest.json">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, runTransaction, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfiguracja i Inicjalizacja Firebase (TERAZ Z RCZNIE WPROWADZONYMI KLUCZAMI)
        const appId = 'ali-mistrzowie-mnozenia'; 
        
        // === WPROWADZONA KONFIGURACJA Z KONSOLI FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyAotvq-QkxFnsnCGomWKBf9DLEHeDNU6SI",
            authDomain: "ali-mistrzowie-mnozenia.firebaseapp.com",
            projectId: "ali-mistrzowie-mnozenia",
            storageBucket: "ali-mistrzowie-mnozenia.firebasestorage.app",
            messagingSenderId: "69323239967",
            appId: "1:69323239967:web:e8b60481b8adb8e7205b2a",
            measurementId: "G-0PPRPMMEPC"
        };
        const initialAuthToken = null; 

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let initialProblemGenerated = false;

        const STATE = {
            progress: {},
            currentProblem: { a: 0, b: 0, result: 0 },
            totalScore: 0,
            streak: 0,
            parentView: false,
            teacherView: false, // NOWY STAN
            feedbackMessage: '',
            isSaving: false,
            roster: [], // Lista uczni贸w do widoku nauczyciela
            currentStudentId: null, // Aktualnie przegldany ucze
            currentStudentName: 'Ja'
        };

        const MAX_FACTOR = 10;
        const MIN_DIFFICULTY = 1;
        const MAX_DIFFICULTY = 10;
        const PROGRESS_COLLECTION = 'learning_progress';
        const ROSTER_COLLECTION = 'class_roster'; // Nowa kolekcja publiczna

        setLogLevel('Debug');

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                        } catch (error) {
                            console.error("Bd autentykacji:", error);
                            userId = crypto.randomUUID();
                        }
                    }
                    isAuthReady = true;
                    STATE.currentStudentId = userId; // Ustaw domylnie na bie偶cego u偶ytkownika
                    console.log("Gotowy do pracy. User ID:", userId);
                    await registerUser(userId); // Rejestracja/Sprawdzenie imienia
                    loadProgress(userId); // adowanie bie偶cego u偶ytkownika
                });

            } catch (error) {
                console.error("Krytyczny bd inicjalizacji Firebase:", error);
                isAuthReady = true;
            }
        }
        
        // --- FUNKCJE DANYCH FIREBASE ---

        /**
         * Zapisuje/sprawdza imi w publicznej licie klasy.
         */
        async function registerUser(uid) {
            const rosterRef = doc(db, 'artifacts', appId, 'public', 'data', ROSTER_COLLECTION, uid);
            const docSnap = await getDoc(rosterRef);

            if (!docSnap.exists()) {
                // Nowy u偶ytkownik - proba o imi
                renderNameInput();
                return new Promise((resolve) => {
                    document.getElementById('saveNameBtn').onclick = async () => {
                        const name = document.getElementById('userNameInput').value.trim();
                        if (name) {
                            // Ten setDoc wymaga uprawnienia 'write' w regule ROSTER_COLLECTION.
                            await setDoc(rosterRef, { name: name, uid: uid, score: 0, lastActive: new Date().toISOString() });
                            STATE.currentStudentName = name;
                            renderApp(); // Wr贸 do g贸wnego widoku
                            resolve();
                        }
                    };
                });
            } else {
                STATE.currentStudentName = docSnap.data().name;
            }
        }

        function getProgressDocRef(uid) {
            const id = uid || STATE.currentStudentId;
            if (!id || !db) return null;
            // Prywatna cie偶ka danych: /artifacts/{appId}/users/{userId}/learning_progress/data
            return doc(db, 'artifacts', appId, 'users', id, PROGRESS_COLLECTION, 'data');
        }

        function getClassRosterRef() {
            // Ta kolekcja wymaga uprawnienia 'read' w regule ROSTER_COLLECTION dla anonimowych u偶ytkownik贸w.
            return collection(db, 'artifacts', appId, 'public', 'data', ROSTER_COLLECTION);
        }

        function loadProgress(uid) {
            if (!isAuthReady || !db || !uid) return;

            const docRef = getProgressDocRef(uid);
            if (!docRef) return;

            // U偶ywamy onSnapshot dla aktualizacji w czasie rzeczywistym
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    STATE.progress = data.progress || {};
                    STATE.totalScore = data.totalScore || 0;
                    STATE.streak = data.streak || 0;
                } else {
                    STATE.progress = {};
                    STATE.totalScore = 0;
                    STATE.streak = 0;
                }
                
                if (uid === userId && !initialProblemGenerated) {
                    generateNewProblem();
                    initialProblemGenerated = true;
                }
                renderApp();

            }, (error) => {
                console.error("Bd adowania postpu w czasie rzeczywistym:", error);
            });
        }
        
        async function saveProgress() {
            if (!isAuthReady || !db || STATE.isSaving) {
                console.log("Nie mo偶na zapisa, autoryzacja niegotowa lub trwa zapis.");
                return;
            }
            STATE.isSaving = true;

            try {
                await runTransaction(db, async (transaction) => {
                    const docRef = getProgressDocRef(userId);
                    
                    const newProgress = {
                        progress: STATE.progress,
                        totalScore: STATE.totalScore,
                        streak: STATE.streak,
                        lastUpdated: new Date().toISOString()
                    };

                    transaction.set(docRef, newProgress);

                    // Aktualizacja score i lastActive w publicznym rosterze
                    // Ta operacja wymaga uprawnienia 'write' (update) w regule ROSTER_COLLECTION.
                    const rosterRef = doc(db, 'artifacts', appId, 'public', 'data', ROSTER_COLLECTION, userId);
                    transaction.update(rosterRef, { 
                        score: STATE.totalScore,
                        lastActive: new Date().toISOString()
                    });
                });
                console.log("Postp i roster zapisane pomylnie.");
            } catch (error) {
                console.error("Bd transakcji zapisu postpu:", error);
            } finally {
                STATE.isSaving = false;
            }
        }


        // --- LOGIKA ADAPTACYJNA I ODPOWIEDZI (bez zmian) ---

        function generateNewProblem() {
            const problems = [];
            for (let a = 1; a <= MAX_FACTOR; a++) {
                for (let b = 1; b <= MAX_FACTOR; b++) {
                    const key = `${a}x${b}`;
                    const stats = STATE.progress[key] || { correct: 0, attempts: 0, difficulty: MIN_DIFFICULTY };
                    
                    let difficultyScore = 0;
                    if (stats.attempts > 0) {
                        const errorRate = 1 - (stats.correct / stats.attempts);
                        difficultyScore = errorRate * 10;
                    }

                    stats.difficulty = Math.ceil(difficultyScore) || MIN_DIFFICULTY; 
                    STATE.progress[key] = stats;

                    for (let i = 0; i < (stats.difficulty + 1); i++) {
                        problems.push({ a, b, difficultyScore });
                    }
                }
            }

            const selectedProblem = problems[Math.floor(Math.random() * problems.length)];
            
            if (selectedProblem) {
                STATE.currentProblem.a = selectedProblem.a;
                STATE.currentProblem.b = selectedProblem.b;
                STATE.currentProblem.result = selectedProblem.a * selectedProblem.b;
            } else {
                STATE.currentProblem.a = Math.floor(Math.random() * MAX_FACTOR) + 1;
                STATE.currentProblem.b = Math.floor(Math.random() * MAX_FACTOR) + 1;
                STATE.currentProblem.result = STATE.currentProblem.a * STATE.currentProblem.b;
            }
            
            STATE.feedbackMessage = '';
            renderApp();
            
            clearInput(); 
        }

        function checkAnswer() {
            const input = document.getElementById('answerInput');
            const userAnswer = parseInt(input.value.trim());
            
            if (isNaN(userAnswer)) {
                STATE.feedbackMessage = "Wprowad藕 liczb!";
                renderApp();
                return;
            }
            
            const { a, b, result } = STATE.currentProblem;
            const key = `${a}x${b}`;

            if (!STATE.progress[key]) {
                STATE.progress[key] = { correct: 0, attempts: 0, difficulty: MIN_DIFFICULTY };
            }

            STATE.progress[key].attempts += 1;
            
            if (userAnswer === result) {
                STATE.progress[key].correct += 1;
                STATE.totalScore += 1;
                STATE.streak += 1;
                STATE.feedbackMessage = `Brawo! Poprawna odpowied藕: ${result}. Zdobywasz punkt!`;
                
                if (STATE.progress[key].difficulty > MIN_DIFFICULTY) {
                    STATE.progress[key].difficulty -= 1;
                }

                setTimeout(() => {
                    generateNewProblem();
                    saveProgress();
                }, 1000); 

            } else {
                STATE.streak = 0;
                STATE.feedbackMessage = `殴le. Spr贸buj jeszcze raz. To dziaanie to ${a} razy ${b}.`;
                
                if (STATE.progress[key].difficulty < MAX_DIFFICULTY) {
                    STATE.progress[key].difficulty += 2;
                }
                
                saveProgress(); 
                clearInput();
            }
            
            renderApp();
        }

        function clearInput() {
            const input = document.getElementById('answerInput');
            if (input) {
                input.value = '';
            }
        }

        // --- RENDEROWANIE UI ---

        function renderApp() {
            if (!STATE.currentStudentName || STATE.currentStudentName === 'adowanie...') {
                return; // Czekamy na input imienia
            }
            renderHeader();
            renderMainContent();
            
            if (!STATE.parentView && !STATE.teacherView) {
                renderVisualization();
            } else if (STATE.parentView) {
                renderParentDashboard();
            } else if (STATE.teacherView) {
                renderTeacherDashboard();
            }
        }

        function renderHeader() {
            const header = document.getElementById('appHeader');
            header.innerHTML = `
                <div class="flex justify-between items-center p-4 shadow-md" style="background-color: #45B7D1; color: white;">
                    <h1 class="text-xl font-bold">Mali Mistrzowie  (${STATE.currentStudentName})</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm">ID: ${userId ? userId.substring(0, 8) + '...' : 'adowanie...'}</span>
                        <button id="toggleTeacherViewBtn" title="Przecz na Panel Nauczyciela" class="bg-white text-gray-800 p-2 rounded-full shadow-lg transition-transform hover:scale-105">
                            <i class="fas fa-graduation-cap"></i>
                        </button>
                        <button id="toggleViewBtn" title="Przecz na Raport Ucznia" class="bg-white text-gray-800 p-2 rounded-full shadow-lg transition-transform hover:scale-105">
                            <i class="fas ${STATE.parentView ? 'fa-book-open' : 'fa-chart-bar'}"></i>
                        </button>
                    </div>
                </div>
                <div class="flex justify-around bg-gray-100 p-2 text-sm text-gray-700">
                    <span class="font-semibold flex items-center"><i class="fas fa-star text-yellow-500 mr-1"></i> Punkty: ${STATE.totalScore}</span>
                    <span class="font-semibold flex items-center"><i class="fas fa-fire text-red-500 mr-1"></i> Seria: ${STATE.streak}</span>
                </div>
            `;
            document.getElementById('toggleViewBtn').onclick = toggleParentView;
            document.getElementById('toggleTeacherViewBtn').onclick = toggleTeacherView;
        }

        function renderMainContent() {
            const content = document.getElementById('appContent');
            content.innerHTML = '';
            
            if (STATE.parentView || STATE.teacherView) {
                // Dashboardy renderowane s w osobnych funkcjach
                return;
            }

            // Widok Dziecka (Trening)
            content.className = 'p-6 space-y-6 flex flex-col items-center';
            content.innerHTML = `
                <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl text-center border-b-4 border-l-4" style="border-color: #4ECDC4;">
                    <p class="text-lg text-gray-600 mb-2">Jaki jest wynik?</p>
                    <div class="text-7xl font-extrabold mb-6" style="color: #45B7D1;">
                        ${STATE.currentProblem.a} <span class="text-5xl">&times;</span> ${STATE.currentProblem.b}
                    </div>
                    <div id="visualizationContainer" class="min-h-[100px] flex justify-center items-center flex-wrap">
                        <!-- Wizualizacja bdzie renderowana przez JS -->
                    </div>
                    <form id="answerForm" class="flex justify-center mt-6 space-x-2">
                        <input type="number" id="answerInput" placeholder="Wpisz odpowied藕" class="p-3 border-2 border-gray-300 rounded-lg w-full max-w-[200px] text-center text-xl focus:border-[#45B7D1] outline-none transition" inputmode="numeric">
                        <button type="submit" class="p-3 bg-green-500 text-white rounded-lg font-bold shadow-md hover:bg-green-600 transition-colors">
                            <i class="fas fa-check"></i>
                        </button>
                    </form>
                    <p id="feedbackMessage" class="mt-4 text-md font-semibold ${STATE.feedbackMessage.includes('Brawo') ? 'text-green-600' : 'text-red-500'}">
                        ${STATE.feedbackMessage}
                    </p>
                    <p class="mt-2 text-xs text-gray-400">Poziom trudnoci tego zadania (AI): ${STATE.progress[`${STATE.currentProblem.a}x${STATE.currentProblem.b}`]?.difficulty || MIN_DIFFICULTY}/${MAX_DIFFICULTY}</p>
                </div>
            `;
            document.getElementById('answerForm').onsubmit = (e) => {
                e.preventDefault();
                checkAnswer();
            };
        }

        function renderVisualization() {
            const container = document.getElementById('visualizationContainer');
            if (!container) return; 

            container.innerHTML = '';

            const { a, b } = STATE.currentProblem;
            
            if (a > 6 || b > 6) {
                container.innerHTML = `<p class="text-sm text-gray-500 mt-2">Dla wikszych liczb skup si na rachunku!</p>`;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'grid p-4 gap-2 bg-yellow-50 rounded-xl shadow-inner';
            grid.style.gridTemplateColumns = `repeat(${b}, minmax(0, 1fr))`;

            for (let i = 0; i < a * b; i++) {
                const dot = document.createElement('div');
                dot.className = 'w-4 h-4 rounded-full shadow-md transition-transform duration-100 ease-in-out hover:scale-110';
                dot.style.backgroundColor = '#4ECDC4';
                grid.appendChild(dot);
            }

            container.appendChild(grid);
        }

        function renderParentDashboard() {
            const content = document.getElementById('appContent');
            content.className = 'p-6 space-y-6';
            
            let currentStudentInfo = STATE.currentStudentName;
            if(STATE.teacherView && STATE.currentStudentId !== userId) {
                 currentStudentInfo = `UCZE: ${STATE.currentStudentName}`;
            } else if(STATE.teacherView) {
                 currentStudentInfo = `WASNY RAPORT (w trybie nauczyciela)`;
            }

            content.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl">
                    <h2 class="text-2xl font-bold mb-4" style="color: #45B7D1;">Raport Postp贸w (${currentStudentInfo})</h2>
                    <p class="mb-4 text-sm text-gray-600">Poni偶ej znajduje si mapa opanowania tabliczki mno偶enia (1-10).</p>
                    <div id="progressGrid" class="grid grid-cols-11 gap-1 border border-gray-200 p-2 rounded-lg">
                        <!-- Nag贸wki osi X -->
                        <div class="text-center font-bold text-gray-500">x</div>
                        ${Array.from({ length: MAX_FACTOR }, (_, i) => `<div class="text-center font-bold text-gray-700">${i + 1}</div>`).join('')}

                        <!-- Kom贸rki wynik贸w -->
                        ${Array.from({ length: MAX_FACTOR }, (_, aIndex) => {
                            const a = aIndex + 1;
                            let row = `<div class="text-center font-bold text-gray-700 p-1">${a}</div>`; // Nag贸wek osi Y
                            for (let bIndex = 0; bIndex < MAX_FACTOR; bIndex++) {
                                const b = bIndex + 1;
                                const key = `${a}x${b}`;
                                const stats = STATE.progress[key] || { correct: 0, attempts: 0 };
                                
                                let colorClass = 'bg-gray-200';
                                let tooltip = 'Brak danych';
                                
                                if (stats.attempts > 0) {
                                    const percentage = (stats.correct / stats.attempts) * 100;
                                    tooltip = `${a}x${b} = ${a * b}. Poprawno: ${stats.correct}/${stats.attempts} (${percentage.toFixed(0)}%)`;

                                    if (percentage >= 90) {
                                        colorClass = 'bg-green-500';
                                    } else if (percentage >= 60) {
                                        colorClass = 'bg-yellow-500';
                                    } else {
                                        colorClass = 'bg-red-500';
                                    }
                                }
                                
                                row += `<div class="w-full h-8 flex items-center justify-center text-white text-xs rounded-sm ${colorClass} transition-all hover:scale-110 hover:z-10 relative group cursor-pointer">
                                            ${a * b}
                                            <span class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">${tooltip}</span>
                                        </div>`;
                            }
                            return row;
                        }).join('')}
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2" style="color: #F7B801;">Legenda Trudnoci:</h3>
                        <div class="flex flex-wrap gap-4 text-sm">
                            <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span> Opanowane ($\geq 90\%$ poprawnoci)</span>
                            <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-500 mr-2"></span> Wymaga powt贸rki ($60-89\%$ poprawnoci)</span>
                            <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-red-500 mr-2"></span> Problematyczne ( $< 60\%$ poprawnoci)</span>
                            <span class="flex items-center"><span class="w-4 h-4 rounded-full bg-gray-200 mr-2"></span> Nieprzetestowane</span>
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg text-sm">
                         <p>ID u偶ytkownika: <code class="font-mono bg-gray-200 p-1 rounded break-all">${STATE.currentStudentId || 'adowanie...'}</code></p>
                    </div>
                </div>
            `;
        }
        
        // --- NOWY PANEL DLA NAUCZYCIELA ---

        async function renderTeacherDashboard() {
            const content = document.getElementById('appContent');
            content.className = 'p-6 space-y-6';

            // adowanie listy uczni贸w
            content.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4" style="color: #45B7D1;">Panel Nauczyciela: Lista Uczni贸w</h2>
                    <p class="mb-4 text-sm text-gray-600">Kliknij na imi ucznia, aby zobaczy szczeg贸owy raport postp贸w.</p>
                    <div id="rosterList" class="space-y-3">
                        <div class="text-center p-8 text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>adowanie listy uczni贸w...</div>
                    </div>
                </div>
                <div id="studentReportContainer">
                    <!-- Tutaj zaaduje si raport ucznia (renderParentDashboard) -->
                </div>
            `;

            const rosterListDiv = document.getElementById('rosterList');
            
            try {
                // Ta operacja wymaga uprawnienia 'read' w regule ROSTER_COLLECTION.
                const rosterSnapshot = await getDocs(query(getClassRosterRef()));
                STATE.roster = rosterSnapshot.docs.map(doc => doc.data()).sort((a, b) => b.score - a.score); // Sortuj po wyniku

                if (STATE.roster.length === 0) {
                    rosterListDiv.innerHTML = `<div class="text-center p-8 text-gray-400">Brak zarejestrowanych uczni贸w.</div>`;
                    return;
                }

                rosterListDiv.innerHTML = `
                    <div class="grid grid-cols-3 font-bold text-sm text-gray-700 border-b pb-1">
                        <div>Imi Ucznia</div>
                        <div class="text-center">Punkty</div>
                        <div class="text-center">Ostatnia Aktywno</div>
                    </div>
                    ${STATE.roster.map(student => `
                        <button data-uid="${student.uid}" 
                                data-name="${student.name}"
                                class="student-button grid grid-cols-3 items-center p-3 rounded-lg text-left shadow-sm transition-colors hover:bg-indigo-100 ${student.uid === STATE.currentStudentId ? 'bg-indigo-200 font-semibold' : 'bg-white'}">
                            <div class="text-lg">${student.name} ${student.uid === userId ? '(Ty)' : ''}</div>
                            <div class="text-center font-bold text-green-600">${student.score}</div>
                            <div class="text-center text-sm text-gray-500">${timeAgo(student.lastActive)}</div>
                        </button>
                    `).join('')}
                `;

                // Dodanie event listener贸w do przycisk贸w
                document.querySelectorAll('.student-button').forEach(button => {
                    button.onclick = (e) => {
                        const uid = e.currentTarget.getAttribute('data-uid');
                        const name = e.currentTarget.getAttribute('data-name');
                        switchStudentView(uid, name);
                    };
                });
                
                // Jeli jest to pierwszy raz, automatycznie zaaduj raport bie偶cego u偶ytkownika.
                if (STATE.currentStudentId === userId) {
                    // Wywoanie renderParentDashboard bez przeadowania listy uczni贸w
                    document.getElementById('studentReportContainer').innerHTML = renderParentDashboard();
                }

            } catch (error) {
                // Ta sekcja wykonuje si przy bdzie braku uprawnie (Missing or insufficient permissions)
                rosterListDiv.innerHTML = `<div class="text-center p-8 text-red-500">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Bd adowania listy. Sprawd藕, czy reguy Firestore zezwalaj na odczyt kolekcji 'class_roster'.
                </div>`;
                console.error("Bd adowania listy uczni贸w (Brak uprawnie?):", error);
            }
        }

        /**
         * Przecza wywietlany raport na innego ucznia i ponownie aduje dane.
         */
        function switchStudentView(uid, name) {
            STATE.currentStudentId = uid;
            STATE.currentStudentName = name;
            // Przeaduj dane postpu dla wybranego UID
            loadProgress(uid); 
            
            // Zmieniamy tylko widok raportu w kontenerze, nie ca stron.
            const reportContainer = document.getElementById('studentReportContainer');
            if (reportContainer) {
                 reportContainer.innerHTML = renderParentDashboard();
            }
            renderTeacherDashboard(); // Odwie偶 list, aby podwietli aktywnego ucznia
        }

        // --- FUNKCJE POMOCNICZE UI ---

        function toggleParentView() {
            STATE.parentView = !STATE.parentView;
            STATE.teacherView = false; // Wycz widok nauczyciela
            // Reset do wasnego postpu
            STATE.currentStudentId = userId; 
            loadProgress(userId); 
            renderApp();
        }

        async function toggleTeacherView() {
            STATE.teacherView = !STATE.teacherView;
            STATE.parentView = false; // Wycz widok rodzica
            
            // Ustaw domylnie na bie偶cego u偶ytkownika (nauczyciela)
            STATE.currentStudentId = userId;
            loadProgress(userId);
            
            if (STATE.teacherView) {
                // Konieczne jest ponowne zaadowanie, aby zaadowa list uczni贸w
                await renderTeacherDashboard();
            }
            renderApp();
        }

        function renderNameInput() {
            const content = document.getElementById('appContent');
            content.className = 'p-6 space-y-6 flex flex-col items-center min-h-screen justify-center';
            content.innerHTML = `
                <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl text-center border-b-4 border-l-4" style="border-color: #4ECDC4;">
                    <h2 class="text-2xl font-bold mb-4" style="color: #45B7D1;">Witaj!</h2>
                    <p class="text-lg text-gray-600 mb-6">Jak masz na imi? (U偶yjemy tego do ledzenia Twoich postp贸w.)</p>
                    <input type="text" id="userNameInput" placeholder="Twoje imi lub pseudonim" class="p-3 border-2 border-gray-300 rounded-lg w-full max-w-[200px] text-center text-xl focus:border-[#45B7D1] outline-none transition" inputmode="text" maxlength="12">
                    <button id="saveNameBtn" class="mt-4 p-3 w-full bg-green-500 text-white rounded-lg font-bold shadow-md hover:bg-green-600 transition-colors">
                        Rozpocznij Trening!
                    </button>
                </div>
            `;
        }
        
        // Konwertuje ISOString na format "X minut temu"
        function timeAgo(dateString) {
            const now = new Date();
            const past = new Date(dateString);
            const seconds = Math.floor((now - past) / 1000);

            if (seconds < 60) return 'teraz';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min. temu`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} godz. temu`;
            return `${Math.floor(seconds / 86400)} dni temu`;
        }

        // Inicjalizacja
        window.onload = initializeFirebase;
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
    </style>
</head>
<body>

    <div id="appHeader" class="sticky top-0 z-10">
        <!-- Nag贸wek i statystyki -->
    </div>

    <div id="appContent">
        <!-- G贸wna tre (Trening lub Raport) -->
        <div class="p-8 text-center text-gray-500">
            <i class="fas fa-spinner fa-spin text-4xl" style="color: #45B7D1;"></i>
            <p class="mt-4">adowanie danych ucznia...</p>
        </div>
    </div>
    
</body>
</html>
